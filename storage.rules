rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o { // This matches all files in your bucket

    // Rules for user avatars
    match /avatars/{userId}/{allPaths=**} {
      // Allow public read for avatars (common for profile pictures)
      allow read: if true;
      // Allow authenticated users to write only to their own avatar path
      // And add some constraints on size and type
      allow write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 2 * 1024 * 1024 // Max 2MB
                   && request.resource.contentType.matches('image/.*'); // Only image types
    }

    // Rules for contract files
    match /contracts/{ownerId}/{fileName} {
      // Allow read access if the user is the direct owner, the agency owner,
      // or a talent member of the agency.
      allow read: if request.auth != null && (
                    // Case 1: User is the direct owner (personal contract)
                    request.auth.uid == ownerId ||
                    // Case 2: User is associated with the agency that owns the contract
                    (exists(/databases/(default)/documents/agencies/$(ownerId)) &&
                     (
                       // User is the agency owner
                       get(/databases/(default)/documents/agencies/$(ownerId)).data.ownerId == request.auth.uid ||
                       // User is a talent member of the agency
                       request.auth.uid in get(/databases/(default)/documents/agencies/$(ownerId)).data.talent.map(t => t.userId)
                     )
                    )
                  );

      // Allow write access (upload, update, delete) only if the user is the direct owner
      // or the agency owner. Talent cannot write to contract files.
      allow write: if request.auth != null && (
                    // Case 1: User is the direct owner (personal contract)
                    request.auth.uid == ownerId ||
                    // Case 2: User is the agency owner
                    (exists(/databases/(default)/documents/agencies/$(ownerId)) &&
                     get(/databases/(default)/documents/agencies/$(ownerId)).data.ownerId == request.auth.uid)
                   )
                   && request.resource.size < 10 * 1024 * 1024 // Max 10MB
                   && (
                     request.resource.contentType.matches('application/pdf') ||
                     request.resource.contentType.matches('application/msword') ||
                     request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
                     request.resource.contentType.matches('text/plain') ||
                     request.resource.contentType.matches('image/jpeg') ||
                     request.resource.contentType.matches('image/png')
                   );
    }
    
    // Rules for receipt images
    match /receipts/{userId}/{fileName} {
      // Allow an authenticated user to read/write their own receipt images
      allow read, write: if request.auth != null && request.auth.uid == userId
                   && request.resource.size < 5 * 1024 * 1024 // Max 5MB for receipts
                   && (
                     request.resource.contentType.matches('image/.*') ||
                     request.resource.contentType.matches('application/pdf')
                   );
    }
  }
}
