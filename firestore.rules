
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requester is the owner of a document
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    // Helper function to check if the requester is part of the specified agency via custom claims
    function isMemberOfAgency(agencyId) {
      return request.auth != null && request.auth.token.primaryAgencyId == agencyId;
    }

    // Helper to determine if the target user is a talent in the requester's agency
    function isTalentInMyAgency(targetUserId) {
        let requesterAgencyId = request.auth.token.primaryAgencyId;
        if (requesterAgencyId == null) {
          return false;
        }
        let targetUser = get(/databases/$(database)/documents/users/$(targetUserId)).data;
        return targetUser.primaryAgencyId == requesterAgencyId;
    }

    // Rules for the users collection
    match /users/{userId} {
      // Allow a user to read their own profile,
      // OR allow an agency member to read the profile of a talent in their agency.
      allow read: if isOwner(userId) || isTalentInMyAgency(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) && 
                       // Prevent users from elevating their own role to agency_owner
                       !(request.resource.data.role != resource.data.role && request.resource.data.role == "agency_owner") &&
                       // Prevent users from making themselves an agency owner directly
                       !(request.resource.data.isAgencyOwner == true && resource.data.isAgencyOwner == false);
      
      match /private_credentials/{credId} {
          allow read, write: if false; // Only backend functions
      }
    }

    // Rules for the contracts collection
    match /contracts/{contractId} {
        // Allow read if the user is the direct owner OR their UID is in the access map.
        allow read: if isOwner(resource.data.userId) || request.auth.uid in resource.data.access;
        // Allow write/update/delete access if the user's UID is a key in the 'access' map.
        allow update, delete: if request.auth.uid in resource.data.access;
        // Allow create if the user's UID is in the new document's access map OR if they are the direct user.
        allow create: if isOwner(request.resource.data.userId) || request.auth.uid in request.resource.data.access;
    }
    

    // Rules for payment intents (server-side only access)
    match /paymentIntents/{intentId} {
      allow read: if isOwner(resource.data.userId) || isOwner(resource.data.creatorId);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for payments log (server-side only access)
    match /payments/{paymentId} {
       allow read: if isOwner(resource.data.userId) || isOwner(resource.data.creatorId);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for email logs (server-side only access)
    match /emailLogs/{logId} {
      // A user can read logs for contracts they own/are part of
      allow read: if get(/databases/$(database)/documents/contracts/$(resource.data.contractId)).data.access[request.auth.uid] != null;
      allow write: if false; // Only backend via Admin SDK
    }
    
    // Rules for bank accounts (user-specific access)
    match /users/{userId}/bankAccounts/{accountId} {
      allow read, write: if isOwner(userId);
    }
    
    // Rules for bank transactions (user-specific access)
    match /users/{userId}/bankTransactions/{transactionId} {
      allow read, write: if isOwner(userId);
    }
    
    // Rules for receipts (user-specific access)
    match /receipts/{receiptId} {
      allow read, create, update, delete: if isOwner(request.resource.data.userId) || isOwner(resource.data.userId);
    }
    
    // Rules for agencies
    match /agencies/{agencyId} {
      allow read: if request.auth != null; // Allow any authenticated user to see basic agency details (e.g., for invitations)
      allow create: if isOwner(request.resource.data.ownerId); // User can create an agency for themselves
      allow update: if isMemberOfAgency(agencyId); // Any member can update (e.g., talent updating commission)
      allow delete: if get(/databases/$(database)/documents/agencies/$(agencyId)).data.ownerId == request.auth.uid; // Only owner can delete
    }
    
    // Rules for internal agency payouts
    match /internalPayouts/{payoutId} {
      allow read: if isMemberOfAgency(resource.data.agencyId) || isOwner(resource.data.talentId);
      allow create: if get(/databases/$(database)/documents/agencies/$(request.resource.data.agencyId)).data.ownerId == request.auth.uid || (request.auth.token.isAgencyAdmin == true && request.auth.token.primaryAgencyId == request.resource.data.agencyId);
      allow update, delete: if false; // Payouts are immutable for now
    }
    
     match /agencyInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
     match /teamInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
  }
}
