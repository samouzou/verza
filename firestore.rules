rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the requester is the owner of the document
    function isUser(uid) {
      return request.auth != null && request.auth.uid == uid;
    }
    
    // Helper function to check if the requester is a member of a specific agency
    function isMemberOfAgency(agencyId) {
      return request.auth != null && request.auth.token.primaryAgencyId == agencyId;
    }

    // Helper to determine if the target user is a talent in the requester's agency
    function isTalentInMyAgency(targetUserId) {
        let requesterAgencyId = request.auth.token.primaryAgencyId;
        // Ensure the requester actually belongs to an agency.
        if (requesterAgencyId == null) {
          return false;
        }
        // Access the target user's document data.
        let targetUser = get(/databases/$(database)/documents/users/$(targetUserId)).data;
        // Allow if the target user's primary agency matches the requester's.
        return targetUser.primaryAgencyId == requesterAgencyId;
    }

    // Rules for the users collection
    match /users/{userId} {
      // Allow a user to read their own profile,
      // OR allow an agency member to read the profile of a talent in their agency.
      allow read: if isUser(userId) || isTalentInMyAgency(userId);
      allow create: if isUser(userId);
      allow update: if isUser(userId) && 
                       // Prevent users from elevating their own role to agency_owner
                       !(request.resource.data.role != resource.data.role && request.resource.data.role == "agency_owner") &&
                       // Prevent users from making themselves an agency owner directly
                       !(request.resource.data.isAgencyOwner == true && resource.data.isAgencyOwner == false);
      
      match /private_credentials/{credId} {
          allow read, write: if false; // Only backend functions
      }
    }

    // Rules for the contracts collection
    match /contracts/{contractId} {
        // GET rule: For fetching a single document. Can use `get()` for more complex checks.
        // Allow if the user is the direct owner OR if they are a member of the owning agency.
        allow get: if isUser(resource.data.userId) || isMemberOfAgency(resource.data.ownerId);

        // LIST rule for PERSONAL contracts: Allows `where('userId', '==', uid)` queries.
        // The query from the client MUST exactly match this condition.
        allow list: if isUser(request.query.filters[0][2]);
        
        // LIST rule for AGENCY contracts: Allows `where('ownerId', '==', agencyId)` queries.
        // The query from the client MUST exactly match this condition.
        allow list: if isMemberOfAgency(request.query.filters[0][2]);

        // WRITE rules: For creating, updating, deleting single documents.
        allow create: if isUser(request.resource.data.userId) || isMemberOfAgency(request.resource.data.ownerId);
        allow update, delete: if isUser(resource.data.userId) || isMemberOfAgency(resource.data.ownerId);
    }
    

    // Rules for payment intents (server-side only access)
    match /paymentIntents/{intentId} {
      allow read: if isUser(resource.data.userId) || isUser(resource.data.creatorId);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for payments log (server-side only access)
    match /payments/{paymentId} {
       allow read: if isUser(resource.data.userId) || isUser(resource.data.creatorId);
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for email logs (server-side only access)
    match /emailLogs/{logId} {
      // A user can read logs for contracts they own/are part of
      allow read: if get(/databases/$(database)/documents/contracts/$(resource.data.contractId)).data.userId == request.auth.uid;
      allow write: if false; // Only backend via Admin SDK
    }
    
    // Rules for bank accounts (user-specific access)
    match /users/{userId}/bankAccounts/{accountId} {
      allow read, write: if isUser(userId);
    }
    
    // Rules for bank transactions (user-specific access)
    match /users/{userId}/bankTransactions/{transactionId} {
      allow read, write: if isUser(userId);
    }
    
    // Rules for receipts (user-specific access)
    match /receipts/{receiptId} {
      allow read, create, update, delete: if isUser(request.resource.data.userId) || isUser(resource.data.userId);
    }
    
    // Rules for agencies
    match /agencies/{agencyId} {
      allow read: if request.auth != null; // Allow any authenticated user to see basic agency details (e.g., for invitations)
      allow create: if isUser(request.resource.data.ownerId); // User can create an agency for themselves
      allow update: if isMemberOfAgency(agencyId); // Any member can update (e.g., talent updating commission)
      allow delete: if get(/databases/$(database)/documents/agencies/$(agencyId)).data.ownerId == request.auth.uid; // Only owner can delete
    }
    
    // Rules for internal agency payouts
    match /internalPayouts/{payoutId} {
      allow read: if isMemberOfAgency(resource.data.agencyId) || isUser(resource.data.talentId);
      allow create: if get(/databases/$(database)/documents/agencies/$(request.resource.data.agencyId)).data.ownerId == request.auth.uid || (request.auth.token.isAgencyAdmin == true && request.auth.token.primaryAgencyId == request.resource.data.agencyId);
      allow update, delete: if false; // Payouts are immutable for now
    }
    
     match /agencyInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
     match /teamInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
  }
}
