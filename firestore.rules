rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an agency owner
    function isAgencyOwner(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.isAgencyOwner == true;
    }
    
    // Helper function to check if the requesting user is the owner of a specific agency
    function isOwnerOfAgency(agencyId) {
      let agencyDoc = get(/databases/$(database)/documents/agencies/$(agencyId));
      return request.auth != null && agencyDoc.data.ownerId == request.auth.uid;
    }
    
    // Helper function to check if the user is an active team member of a specific agency using custom claims (more efficient)
    function isTeamMember(agencyId) {
      return request.auth != null && request.auth.token.primaryAgencyId == agencyId;
    }
    
    // Corrected Helper: Check if the requester is a team member of an agency owned by the target user.
    function isTeamMemberOfAgencyOwnedBy(targetUserId) {
      let agencyId = request.auth.token.primaryAgencyId; // Use token
      // Check if agencyId exists in the token and the target user owns that agency
      return agencyId != null && 
             get(/databases/$(database)/documents/agencies/$(agencyId)).data.ownerId == targetUserId;
    }


    // Helper functions to allow user to access email logs
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // Helper to check direct user ownership or agency ownership/membership of a contract
    function userOwnsContract(contractId) {
      let contractData = get(/databases/$(database)/documents/contracts/$(contractId)).data;
      // User is the talent on the contract OR
      // Contract is owned by an agency and the requester is the owner of that specific agency OR
      // Contract is owned by an agency and the requester is a team member of that agency
      return isUser(contractData.userId) || 
             (contractData.ownerType == 'agency' && isOwnerOfAgency(contractData.ownerId)) ||
             (contractData.ownerType == 'agency' && isTeamMember(contractData.ownerId));
    }

    // Rules for the users collection
    match /users/{userId} {
      allow read: if isUser(userId) || isTeamMemberOfAgencyOwnedBy(userId);
      allow create: if isUser(userId);
      allow update: if isUser(userId) && 
                       !(request.resource.data.role != resource.data.role && request.resource.data.role == "agency_owner") &&
                       !(request.resource.data.isAgencyOwner == true && resource.data.isAgencyOwner == false);
      
      // Rules for private credentials subcollection
      match /private_credentials/{credId} {
          // NO client read/write access. Only backend functions can access this.
          allow read, write: if false;
      }
    }

    // Rules for the contracts collection
    match /contracts/{contractId} {
      // READ/UPDATE/DELETE: Allow if...
      // 1. You are the talent on the contract (covers personal contracts AND talent-assigned agency contracts)
      // 2. You are the owner of the agency that owns the contract
      // 3. You are a team member of the agency that owns the contract (using custom token)
      allow read, update, delete: if request.auth != null && (
          isUser(resource.data.userId) || 
          (resource.data.ownerType == 'agency' && isOwnerOfAgency(resource.data.ownerId)) || 
          (resource.data.ownerType == 'agency' && isTeamMember(resource.data.ownerId))
      );
      
      // CREATE: Allow if...
      // 1. You are creating a contract for yourself (personal)
      // 2. You are an owner of the agency you're creating the contract for
      // 3. You are a team member of the agency you're creating the contract for (using custom token)
      allow create: if request.auth != null && (
          isUser(request.resource.data.userId) ||
          (request.resource.data.ownerType == 'agency' && isOwnerOfAgency(request.resource.data.ownerId)) ||
          (request.resource.data.ownerType == 'agency' && isTeamMember(request.resource.data.ownerId))
      );
    }
    

    // Rules for payment intents (server-side only access)
    match /paymentIntents/{intentId} {
      allow read: if request.auth != null && (
                    request.auth.uid == resource.data.userId ||  // Payer
                    request.auth.uid == resource.data.creatorId // Creator/Recipient
                  );
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for payments log (server-side only access)
    match /payments/{paymentId} {
       allow read: if request.auth != null && (
                    request.auth.uid == resource.data.userId || // Payer mentioned in metadata
                    request.auth.uid == resource.data.creatorId // Creator/Recipient if you add this field
                  );
      allow create, update, delete: if false; // Only backend via Admin SDK
    }
    
    // Rules for email logs (server-side only access)
    match /emailLogs/{logId} {
      allow read: if userOwnsContract(resource.data.contractId); // User can read logs for their own contracts
      allow write: if false; // Only backend via Admin SDK
    }
    
    // Rules for bank accounts (user-specific access)
    match /users/{userId}/bankAccounts/{accountId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Rules for bank transactions (user-specific access)
    match /users/{userId}/bankTransactions/{transactionId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Rules for receipts (user-specific access)
    match /receipts/{receiptId} {
      allow read, update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // Rules for agencies
    match /agencies/{agencyId} {
      allow read: if request.auth != null; // Allow any authenticated user to read agency details (e.g., for invitations)
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerId; // Allow user to create agency for themselves
      allow update: if request.auth != null && (isOwnerOfAgency(agencyId) || isTeamMember(agencyId));
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId; // Only owner can manage
    }
    
    // Rules for internal agency payouts
    match /internalPayouts/{payoutId} {
      allow read: if isOwnerOfAgency(resource.data.agencyId) || 
                     isTeamMember(resource.data.agencyId) ||
                     request.auth.uid == resource.data.talentId;
      allow create: if request.auth.uid == request.resource.data.agencyOwnerId;
      allow update, delete: if false; // Payouts are immutable for now
    }
    
     match /agencyInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
     match /teamInvitations/{invitationId} {
        allow read: if request.auth.uid != null;
        allow write: if false; // Only backend can write
     }
     
  }
}
